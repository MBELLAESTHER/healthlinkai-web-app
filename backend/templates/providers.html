{% extends "base.html" %}

{% block title %}Healthcare Providers - HealthLinkAI{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-cool-gray-900 mb-4">
            Find Healthcare Providers
        </h1>
        <p class="text-xl text-cool-gray-600 max-w-2xl mx-auto">
            Connect with qualified healthcare professionals in your area. Filter by specialty, location, and availability.
        </p>
    </div>

    <!-- Location Detection -->
    <div class="bg-gradient-to-r from-teal-50 to-blue-50 rounded-2xl p-6 mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-lg font-semibold text-cool-gray-900 mb-2">Find Providers Near You</h3>
                <p class="text-sm text-cool-gray-600">Get personalized results based on your location</p>
            </div>
            <div class="flex space-x-3">
                <button id="get-location-btn" 
                        class="bg-teal-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-teal-700 transition-colors flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    Use My Location
                </button>
                <select id="manual-city" class="px-4 py-2 border border-cool-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500">
                    <option value="">Select City</option>
                    <option value="douala" data-lat="4.0511" data-lng="9.7679">Douala</option>
                    <option value="yaounde" data-lat="3.8480" data-lng="11.5021">Yaound√©</option>
                </select>
            </div>
        </div>
        <div id="location-status" class="mt-3 text-sm" style="display: none;"></div>
    </div>

    <!-- Search and Filters -->
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div>
                <label for="search" class="block text-sm font-medium text-cool-gray-700 mb-2">Search</label>
                <input type="text" id="search" placeholder="Provider name or specialty..."
                       class="w-full px-4 py-3 border border-cool-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                       aria-describedby="search-help">
                <p id="search-help" class="text-xs text-cool-gray-500 mt-1">Search by name, specialty, or hospital</p>
            </div>
            <div>
                <label for="specialty" class="block text-sm font-medium text-cool-gray-700 mb-2">Specialty</label>
                <select id="specialty" 
                        class="w-full px-4 py-3 border border-cool-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                    <option value="">All Specialties</option>
                    <option value="general_practitioner">General Practice</option>
                    <option value="cardiologist">Cardiology</option>
                    <option value="dermatologist">Dermatology</option>
                    <option value="pediatrician">Pediatrics</option>
                    <option value="psychiatrist">Psychiatry</option>
                    <option value="psychologist">Psychology</option>
                    <option value="orthopedist">Orthopedics</option>
                    <option value="gynecologist">Gynecology</option>
                </select>
            </div>
            <div>
                <label for="distance" class="block text-sm font-medium text-cool-gray-700 mb-2">Max Distance</label>
                <select id="distance" 
                        class="w-full px-4 py-3 border border-cool-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent">
                    <option value="5">Within 5 km</option>
                    <option value="10">Within 10 km</option>
                    <option value="25" selected>Within 25 km</option>
                    <option value="50">Within 50 km</option>
                    <option value="">Any distance</option>
                </select>
            </div>
            <div class="flex items-end">
                <button id="search-btn"
                        class="w-full bg-teal-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-teal-700 transition-colors"
                        aria-label="Search providers">
                    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    Search
                </button>
            </div>
        </div>
        
        <!-- Sort Options -->
        <div class="flex items-center justify-between border-t border-cool-gray-200 pt-4">
            <div class="flex items-center space-x-4">
                <span class="text-sm font-medium text-cool-gray-700">Sort by:</span>
                <select id="sort" class="border border-cool-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-teal-500">
                    <option value="distance">Distance</option>
                    <option value="rating">Rating</option>
                    <option value="name">Name</option>
                    <option value="availability">Availability</option>
                </select>
            </div>
            <div class="text-sm text-cool-gray-600">
                <span id="results-count">0</span> providers found
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Providers List -->
        <div class="lg:col-span-2">
            <div class="space-y-6" id="providers-list" role="main" aria-label="Healthcare providers list">
                <!-- Provider cards will be populated here -->
            </div>
        </div>

        <!-- Map Placeholder & Quick Stats -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Map Placeholder -->
            <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-8">
                <h3 class="text-lg font-semibold text-cool-gray-900 mb-4">Provider Locations</h3>
                <div class="bg-gradient-to-br from-teal-50 to-blue-50 rounded-lg h-64 flex items-center justify-center border-2 border-dashed border-teal-200">
                    <div class="text-center">
                        <svg class="w-12 h-12 text-teal-500 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <p class="text-teal-700 font-medium">Interactive Map</p>
                        <p class="text-teal-600 text-sm mt-1">Coming Soon</p>
                        <p class="text-cool-gray-500 text-xs mt-2">View provider locations and get directions</p>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-semibold text-cool-gray-900 mb-4">Network Stats</h3>
                <div class="space-y-4">
                    <div class="flex items-center justify-between">
                        <span class="text-cool-gray-600">Total Providers</span>
                        <span class="font-semibold text-teal-600">500+</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-cool-gray-600">Specialties</span>
                        <span class="font-semibold text-teal-600">25+</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-cool-gray-600">Cities Covered</span>
                        <span class="font-semibold text-teal-600">10+</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-cool-gray-600">Avg. Rating</span>
                        <span class="font-semibold text-teal-600">4.8‚≠ê</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// User location variables
let userLat = null;
let userLng = null;

// Geolocation functionality
const getLocationBtn = document.getElementById('get-location-btn');
const manualCitySelect = document.getElementById('manual-city');
const locationStatus = document.getElementById('location-status');

getLocationBtn.addEventListener('click', function() {
    if (navigator.geolocation) {
        locationStatus.style.display = 'block';
        locationStatus.innerHTML = '<span class="text-blue-600">üìç Getting your location...</span>';
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLat = position.coords.latitude;
                userLng = position.coords.longitude;
                locationStatus.innerHTML = '<span class="text-green-600">‚úÖ Location detected! Showing nearest providers.</span>';
                loadNearestProviders();
            },
            function(error) {
                let errorMsg = '';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMsg = '‚ùå Location access denied. Please use manual city selection.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMsg = '‚ùå Location unavailable. Please use manual city selection.';
                        break;
                    case error.TIMEOUT:
                        errorMsg = '‚ùå Location request timed out. Please use manual city selection.';
                        break;
                    default:
                        errorMsg = '‚ùå An error occurred. Please use manual city selection.';
                        break;
                }
                locationStatus.innerHTML = `<span class="text-red-600">${errorMsg}</span>`;
            }
        );
    } else {
        locationStatus.style.display = 'block';
        locationStatus.innerHTML = '<span class="text-red-600">‚ùå Geolocation not supported. Please use manual city selection.</span>';
    }
});

manualCitySelect.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption.value) {
        userLat = parseFloat(selectedOption.dataset.lat);
        userLng = parseFloat(selectedOption.dataset.lng);
        locationStatus.style.display = 'block';
        locationStatus.innerHTML = `<span class="text-green-600">‚úÖ Using ${selectedOption.text} as your location.</span>`;
        loadNearestProviders();
    }
});

function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // Earth's radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function loadNearestProviders() {
    if (!userLat || !userLng) return;
    
    // Mock providers with realistic Cameroon data
    currentProviders = [
        {
            id: 1,
            name: "Dr. Sarah Johnson",
            specialty: "General Practitioner",
            type: "general_practitioner",
            phone: "+237-233-44-55-66",
            email: "dr.johnson@healthcenter.cm",
            address: "123 Rue de la Paix, Douala",
            latitude: 4.0511,
            longitude: 9.7679,
            rating: 4.8,
            availability: "Available today",
            languages: ["French", "English"],
            distance_km: calculateDistance(userLat, userLng, 4.0511, 9.7679),
            distance_display: `${calculateDistance(userLat, userLng, 4.0511, 9.7679).toFixed(1)} km`
        },
        {
            id: 2,
            name: "Dr. Michael Chen",
            specialty: "Psychiatrist",
            type: "psychiatrist",
            phone: "+237-233-44-55-77",
            email: "dr.chen@mindwellclinic.cm",
            address: "456 Avenue Kennedy, Yaound√©",
            latitude: 3.8480,
            longitude: 11.5021,
            rating: 4.9,
            availability: "Next available: Tomorrow",
            languages: ["French", "English", "Chinese"],
            distance_km: calculateDistance(userLat, userLng, 3.8480, 11.5021),
            distance_display: `${calculateDistance(userLat, userLng, 3.8480, 11.5021).toFixed(1)} km`
        }
    ];
    
    // Sort by distance and update display
    currentProviders.sort((a, b) => a.distance_km - b.distance_km);
    applyFilters();
}

// Initialize providers data
let currentProviders = [];

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search');
    const specialtySelect = document.getElementById('specialty');
    const distanceSelect = document.getElementById('distance');
    const searchBtn = document.getElementById('search-btn');
    const sortSelect = document.getElementById('sort');
    const providersList = document.getElementById('providers-list');
    const resultsCount = document.getElementById('results-count');

    // Event listeners
    searchBtn.addEventListener('click', applyFilters);
    searchInput.addEventListener('input', applyFilters);
    specialtySelect.addEventListener('change', applyFilters);
    distanceSelect.addEventListener('change', applyFilters);
    sortSelect.addEventListener('change', applySorting);

    // Load initial mock data if no location set
    if (!userLat || !userLng) {
        loadMockData();
    }

    function loadMockData() {
        currentProviders = [
            {
                id: 1,
                name: "Dr. Sarah Johnson",
                specialty: "General Practitioner",
                type: "general_practitioner",
                phone: "+237-233-44-55-66",
                email: "dr.johnson@healthcenter.cm",
                address: "123 Rue de la Paix, Douala",
                rating: 4.8,
                availability: "Available today",
                languages: ["French", "English"],
                distance_km: 2.3,
                distance_display: "2.3 km"
            },
            {
                id: 2,
                name: "Dr. Michael Chen",
                specialty: "Psychiatrist",
                type: "psychiatrist",
                phone: "+237-233-44-55-77",
                email: "dr.chen@mindwellclinic.cm",
                address: "456 Avenue Kennedy, Yaound√©",
                rating: 4.9,
                availability: "Next available: Tomorrow",
                languages: ["French", "English", "Chinese"],
                distance_km: 5.7,
                distance_display: "5.7 km"
            }
        ];
        applyFilters();
    }

    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedSpecialty = specialtySelect.value;
        const maxDistance = parseFloat(distanceSelect.value);

        let filteredProviders = currentProviders.filter(provider => {
            const matchesSearch = !searchTerm || 
                provider.name.toLowerCase().includes(searchTerm) ||
                provider.specialty.toLowerCase().includes(searchTerm);
            
            const matchesSpecialty = !selectedSpecialty || 
                provider.type === selectedSpecialty;
            
            const matchesDistance = !maxDistance || 
                provider.distance_km <= maxDistance;

            return matchesSearch && matchesSpecialty && matchesDistance;
        });

        applySorting(filteredProviders);
    }

    function applySorting(providers = null) {
        const sortBy = sortSelect.value;
        const providersToSort = providers || currentProviders;
        
        providersToSort.sort((a, b) => {
            switch(sortBy) {
                case 'distance':
                    return a.distance_km - b.distance_km;
                case 'rating':
                    return b.rating - a.rating;
                case 'name':
                    return a.name.localeCompare(b.name);
                case 'availability':
                    const availabilityOrder = {
                        'Available today': 1,
                        'Next available: Tomorrow': 2,
                        'Available this week': 3,
                        'Available next week': 4
                    };
                    return (availabilityOrder[a.availability] || 5) - (availabilityOrder[b.availability] || 5);
                default:
                    return 0;
            }
        });

        displayProviders(providersToSort);
    }

    function displayProviders(providers) {
        resultsCount.textContent = providers.length;

        if (providers.length === 0) {
            providersList.innerHTML = `
                <div class="text-center py-12">
                    <svg class="w-16 h-16 text-cool-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 12h6m-6-4h6m2 5.291A7.962 7.962 0 0112 15c-2.34 0-4.29-1.009-5.824-2.562M15 6.5a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <h3 class="text-lg font-medium text-cool-gray-900 mb-2">No providers found</h3>
                    <p class="text-cool-gray-600">Try adjusting your search criteria or filters</p>
                </div>
            `;
            return;
        }
        
        providersList.innerHTML = providers.map(provider => `
            <article class="bg-white rounded-2xl shadow-lg p-6 hover:shadow-xl transition-shadow" role="article" aria-labelledby="provider-${provider.id}">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-start space-x-4">
                        <div class="w-16 h-16 bg-teal-100 rounded-full flex items-center justify-center flex-shrink-0" aria-hidden="true">
                            <svg class="w-8 h-8 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 id="provider-${provider.id}" class="text-xl font-bold text-cool-gray-900">${provider.name}</h3>
                            <p class="text-teal-600 font-medium">${provider.specialty}</p>
                            <p class="text-cool-gray-600">${provider.address}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="flex items-center space-x-1 mb-1">
                            <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                            </svg>
                            <span class="text-sm font-medium text-cool-gray-900">${provider.rating}</span>
                        </div>
                        <p class="text-sm text-cool-gray-600">${provider.distance_display}</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-cool-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                        <a href="tel:${provider.phone}" class="text-sm text-teal-600 hover:text-teal-700 font-medium">${provider.phone}</a>
                    </div>
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-cool-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <a href="mailto:${provider.email}" class="text-sm text-teal-600 hover:text-teal-700 font-medium">${provider.email}</a>
                    </div>
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-cool-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="text-sm text-cool-gray-600">${provider.availability}</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <svg class="w-4 h-4 text-cool-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
                        </svg>
                        <span class="text-sm text-cool-gray-600">${provider.languages.join(', ')}</span>
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex space-x-2">
                        <a href="tel:${provider.phone}" 
                           class="bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-teal-700 transition-colors flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                            </svg>
                            Call Now
                        </a>
                        <a href="mailto:${provider.email}" 
                           class="bg-cool-gray-200 text-cool-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-cool-gray-300 transition-colors flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                            Email
                        </a>
                    </div>
                    <button class="bg-teal-100 text-teal-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-teal-200 transition-colors"
                            aria-label="Book appointment with ${provider.name}">
                        Book Appointment
                    </button>
                </div>
            </article>
        `).join('');
    }
});

// Geolocation and provider search functionality (variables already declared above)

// Get user's location
function getUserLocation() {
    const locationStatus = document.getElementById('location-status');
    const citySelect = document.getElementById('city-select');
    
    if (navigator.geolocation) {
        locationStatus.innerHTML = `
            <div class="flex items-center space-x-2 text-blue-600">
                <svg class="w-4 h-4 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                <span>Getting your location...</span>
            </div>
        `;
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                userLat = position.coords.latitude;
                userLng = position.coords.longitude;
                
                locationStatus.innerHTML = `
                    <div class="flex items-center space-x-2 text-green-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span>Location detected</span>
                    </div>
                `;
                
                citySelect.style.display = 'none';
                loadNearestProviders();
            },
            function(error) {
                locationStatus.innerHTML = `
                    <div class="flex items-center space-x-2 text-amber-600">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <span>Location access denied. Please select your city manually.</span>
                    </div>
                `;
                citySelect.style.display = 'block';
            }
        );
    } else {
        locationStatus.innerHTML = `
            <div class="flex items-center space-x-2 text-red-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
                <span>Geolocation not supported. Please select your city manually.</span>
            </div>
        `;
        citySelect.style.display = 'block';
    }
}

// Manual city selection
function selectCity() {
    const citySelect = document.getElementById('city-select');
    const selectedCity = citySelect.value;
    
    if (selectedCity) {
        const cityCoords = {
            'douala': { lat: 4.0511, lng: 9.7679 },
            'yaounde': { lat: 3.8480, lng: 11.5021 }
        };
        
        userLat = cityCoords[selectedCity].lat;
        userLng = cityCoords[selectedCity].lng;
        
        const locationStatus = document.getElementById('location-status');
        locationStatus.innerHTML = `
            <div class="flex items-center space-x-2 text-green-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span>Location set to ${selectedCity.charAt(0).toUpperCase() + selectedCity.slice(1)}</span>
            </div>
        `;
        
        loadNearestProviders();
    }
}

// Calculate distance using Haversine formula
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Earth's radius in kilometers
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Load nearest providers based on user location
function loadNearestProviders() {
    if (!userLat || !userLng) return;
    
    currentProviders = [
        {
            id: 1,
            name: "Dr. Sarah Johnson",
            specialty: "General Practitioner",
            type: "general_practitioner",
            phone: "+237-233-44-55-66",
            email: "dr.johnson@healthcenter.cm",
            address: "123 Rue de la Paix, Douala",
            latitude: 4.0511,
            longitude: 9.7679,
            rating: 4.8,
            availability: "Available today",
            languages: ["French", "English"],
            distance_km: calculateDistance(userLat, userLng, 4.0511, 9.7679),
            distance_display: `${calculateDistance(userLat, userLng, 4.0511, 9.7679).toFixed(1)} km`
        },
        {
            id: 2,
            name: "Dr. Michael Chen",
            specialty: "Psychiatrist",
            type: "psychiatrist",
            phone: "+237-233-44-55-77",
            email: "dr.chen@mindwellclinic.cm",
            address: "456 Avenue Kennedy, Yaound√©",
            latitude: 3.8480,
            longitude: 11.5021,
            rating: 4.9,
            availability: "Next available: Tomorrow",
            languages: ["French", "English", "Chinese"],
            distance_km: calculateDistance(userLat, userLng, 3.8480, 11.5021),
            distance_display: `${calculateDistance(userLat, userLng, 3.8480, 11.5021).toFixed(1)} km`
        }
    ];
    
    // Sort by distance and update display
    currentProviders.sort((a, b) => a.distance_km - b.distance_km);
    applyFilters();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    getUserLocation();
});

</script>
{% endblock %}
